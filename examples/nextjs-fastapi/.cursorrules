# Cursor Rules - Next.js 15 + FastAPI Project

## Tech Stack

### Frontend
- **Framework**: Next.js 15 (App Router)
- **Language**: TypeScript (strict mode)
- **Styling**: Tailwind CSS + shadcn/ui
- **State**: TanStack Query (server state) + Zustand (client state)
- **Forms**: React Hook Form + Zod validation

### Backend
- **Framework**: FastAPI
- **Language**: Python 3.11+
- **Validation**: Pydantic v2
- **Database**: PostgreSQL / SQLAlchemy 2.0
- **Task Queue**: Celery + Redis
- **Monitoring**: Sentry

---

## Frontend Patterns

### Component Structure
```typescript
'use client'; // Only if using hooks/state/browser APIs

import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
// External imports first, internal second, types last

interface Props {
  // Props interface inline or imported
}

export function ComponentName({ prop }: Props) {
  // 1. Hooks
  const [state, setState] = useState();
  const { data, isLoading } = useQuery({...});

  // 2. Derived state
  const computed = useMemo(() => ..., [deps]);

  // 3. Handlers
  const handleClick = () => {...};

  // 4. Return JSX
  if (isLoading) return <LoadingSkeleton />;
  return <div>...</div>;
}
```

### Data Fetching
```typescript
// TanStack Query for server state
const { data, isLoading, error } = useQuery({
  queryKey: ['items', id],
  queryFn: () => fetchItem(id),
});

// Mutations
const mutation = useMutation({
  mutationFn: createItem,
  onSuccess: () => queryClient.invalidateQueries(['items']),
});
```

### Styling
```typescript
import { cn } from '@/lib/utils';

<div className={cn(
  'base-styles',
  condition && 'conditional-styles',
  className
)} />
```

---

## Backend Patterns

### Router Structure
```python
from fastapi import APIRouter, Depends, HTTPException, status
from typing import Annotated

router = APIRouter(prefix="/items", tags=["items"])

@router.get("", response_model=ItemList)
async def list_items(
    db: Annotated[AsyncSession, Depends(get_db)],
    current_user: Annotated[User, Depends(get_current_user)],
    skip: int = 0,
    limit: int = 100,
):
    """List all items."""
    service = ItemService(db)
    return await service.get_all(user_id=current_user.id, skip=skip, limit=limit)

@router.post("", response_model=ItemResponse, status_code=status.HTTP_201_CREATED)
async def create_item(
    item_data: ItemCreate,
    db: Annotated[AsyncSession, Depends(get_db)],
    current_user: Annotated[User, Depends(get_current_user)],
):
    """Create a new item."""
    service = ItemService(db)
    return await service.create(user_id=current_user.id, data=item_data)
```

### Pydantic Schemas
```python
from pydantic import BaseModel, Field, ConfigDict

class BaseSchema(BaseModel):
    model_config = ConfigDict(from_attributes=True)

class ItemCreate(BaseModel):
    title: str = Field(..., min_length=1, max_length=200)
    description: str | None = Field(None, max_length=1000)

class ItemResponse(BaseSchema):
    id: str
    title: str
    description: str | None
    created_at: datetime
```

### Error Handling
```python
import logging
import sentry_sdk

logger = logging.getLogger(__name__)

try:
    result = await service.operation()
except SpecificError as e:
    logger.warning("Expected error", extra={"error": str(e)})
    raise HTTPException(status_code=400, detail=str(e))
except Exception as e:
    logger.error("Unexpected error", extra={"error": str(e)}, exc_info=True)
    sentry_sdk.capture_exception(e)
    raise HTTPException(status_code=500, detail="Internal server error")
```

---

## Commands

```bash
# Frontend
cd frontend && pnpm dev      # Development
cd frontend && pnpm build    # Build
cd frontend && pnpm lint     # Lint

# Backend
cd backend/api
source .venv/bin/activate
uvicorn main:app --reload    # Development
pytest                       # Tests
ruff check .                 # Lint
mypy .                       # Type check
```

---

## Don't Do

- Don't use `any` type in TypeScript
- Don't use `console.log` in production (use logger)
- Don't catch errors without logging them
- Don't skip the 'use client' directive when using hooks
- Don't commit .env files
- Don't add features not explicitly requested
